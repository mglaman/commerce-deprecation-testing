image: circleci/php:7.2-cli
stages:
  - build
  - inspect
cache:
  paths:
    - vendor
    - ~/.composer/cache

before_script:
  - echo 'memory_limit=-1' | sudo tee -a /usr/local/etc/php/php.ini

build:
  stage: build
  before_script:
    - sudo apt-get install libpng-dev -y
    - sudo docker-php-ext-install gd
    - composer -n global require -n "hirak/prestissimo"
  script: composer install -n --prefer-dist
  artifacts:
    paths:
      - bin
      - vendor
      - web

.job_template: &job_template
  stage: inspect
  script: ./vendor/bin/phpstan analyse web/modules/contrib/$CI_JOB_NAME --no-progress

address:
  <<: *job_definition
commerce:
  <<: *job_definition
entity:
  <<: *job_definition
entity_reference_revisions:
  <<: *job_definition
inline_entity_form:
  <<: *job_definition
profile:
  <<: *job_definition
state_machine:
  <<: *job_definition